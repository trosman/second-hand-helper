<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-app.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-analytics.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-functions.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-storage.js"></script>

<script>
  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  var firebaseConfig = {
    apiKey: "AIzaSyCMWv3TzZuGPDg41K8wa_PY10rgtitoCnA",
    authDomain: "second-hand-helper.firebaseapp.com",
    projectId: "second-hand-helper",
    storageBucket: "second-hand-helper.appspot.com",
    messagingSenderId: "886292162262",
    appId: "1:886292162262:web:a5679ec376bdec00600b77",
    measurementId: "G-654T8V21EB"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();
  var db = firebase.firestore();
  var functions = firebase.functions();
  var storage = firebase.storage();
</script>

<script>
  // FUNCTIONS FOR START PAGE
  function loadRecentlySold() {
    console.log("Funktionen loadRecentlySold påbörjad!");
    var data = {};

    // [START fb_functions_call_add_message_error]
    var addMessage = firebase.functions().httpsCallable('addMessage');

    addMessage()
      .then((result) => {
        // Read result of the Cloud Function.
        console.log('Cloud Function är klar! Nu gör vi något med resultatet!');

        var itemListRecentlySoldStartPage = document.getElementById('itemListRecentlySoldStartPage');
        itemListRecentlySoldStartPage.innerHTML = "";

        data = result.data;

        for (var key in data) {
          if (data.hasOwnProperty(key)) {
            var brand = data[key].brand;
            var soldPrice = data[key].soldPrice;
            var imageUrl = data[key].imageUrl;
            var itemCardHTML = `<div class="div-block-14"><div class="ratio-box _16-9"><div class="conten-block with-image"><div class="img-container" style="background-image: url('${imageUrl}');"></div></div></div><div class="text-block-14">${soldPrice} kr</div><div class='text-block-34'>${brand}</div></div>`;
            var itemListRecentlySoldStartPage = document.getElementById('itemListRecentlySoldStartPage');
            itemListRecentlySoldStartPage.innerHTML += itemCardHTML;

          }
        }
      })
      .catch((error) => {
        // Getting the Error details.
        var code = error.code;
        var message = error.message;
        var details = error.details;
        console.log('Error message: ', message, code);
      });
    // [END fb_functions_call_add_message_error]
  }


  // FUNCTIONS FOR PRIVATE PAGE

  function setInitialStylePrivatePage() {
    noItemsDiv.style.display = "none";
    myItemsDiv.style.display = "none";
    soldNotSentDiv.style.display = "none";
    soldItemsDiv.style.display = "none";
    soldByOthersDiv.style.display = "none";
    itemListSoldContainer.style.display = "none";
    headerSellItemButton.style.display = "none";
    header.style.backgroundColor = "transparent";
    quickInfoDiv.style.display = "none";
    bookPickupToast.style.display = "none";
    openQuestionDiv.style.display = "none";
    feedbackForm.style.display = "none";
    feedbackSubmitButton.style.display = "none";
  }

  async function ifSoldItemAskForAddress(userID) {
    let status = "";
    let shippingStatus = "";
    let addressFirstName = "";

    // First, get items with status "Sold" and shippingStatus "Not sent"
    await db.collection("items")
      .where("user", "==", userID)
      .where("status", "==", "Sold")
      .where("shippingStatus", "==", "Not sent")
      .orderBy("soldDate")
      .get()
      .then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          status = doc.data().status;
          shippingStatus = doc.data().shippingStatus;
        });
      });

    // Second, check if user has no address added yet
    await db.collection("users").doc(userID).get().then((doc) => {
      addressFirstName = doc.data().addressFirstName;
    });

    // Third, redirect user if user has no address and at least one item that's sold but not shipped
    if (status == "Sold" && shippingStatus == "Not sent" && addressFirstName == undefined) {
      window.location.href = window.location.origin + "/address-form";
    }
  }

  function loadSoldByOthers(userID) {
    var itemListSoldByOthers = document.getElementById('itemListSoldByOthers');

    // SOLD BY OTHERS QUERY + Add cards to list
    db.collection("items")
      .where("status", "==", "Sold")
      .orderBy('soldDate', 'desc')
      .limit(20)
      .get()
      .then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          var sellerId = doc.data().user;
          var brand = doc.data().brand;
          var soldPrice = doc.data().soldPrice;
          var images = doc.data().images;
          var imageUrl = images.frontImage;

          // Add card to list if seller is other than myself
          if (sellerId != userID) {
            if ("productImage" in images) {
              imageUrl = images.productImage;
            }
            var soldByOthersItemCardHTML = `<div class="div-block-14"><div class="ratio-box _16-9"><div class="conten-block with-image"><div class="img-container" style="background-image: url('${imageUrl}');"></div></div></div><div class="text-block-14">${soldPrice} kr</div><div class='text-block-34'>${brand}</div></div>`;
            itemListSoldByOthers.innerHTML += soldByOthersItemCardHTML;
          }
        });
      });
  }

  function getPickupTimeInfoDiv(pickupDate) {
    // Update the pickup time to display to user
    var date = new Date(pickupDate);
    var days = ['Söndag', 'Måndag', 'Tisdag', 'Onsdag', 'Torsdag', 'Fredag', 'Lördag'];
    var months = ['jan', 'feb', 'mar', 'apr', 'maj', 'jun', 'jul', 'aug', 'sep', 'okt', 'nov', 'dec'];
    var dateNumber = date.getDate();
    var monthName = months[date.getMonth()];
    var dayName = days[date.getDay()];
    var pickupTimeInfoText = dayName + ", " + dateNumber + " " + monthName + ", kl 9-16";
    const div = `<div id="pickupTimeInfoDiv" class="div-block-54">
                                        <img src="https://global-uploads.webflow.com/6055e6b453114a22c1c345f0/608db91c363e28ae251e0998_delivery-truck%204.svg" loading="lazy" width="34" alt="" class="image-12">
                                        <div class="text-block-17-copy">Hämtas upp</div>
                                        <div id="pickupTimeInfoText" class="text-block-17-copy">${pickupTimeInfoText}</div>
                                    </div>`;
    return div;
  }

  function getBookPickupButton(itemId, soldDate, brand) {
    const div = `<a id="bookPickupButton" href="javascript:openPickupToast('${itemId}', '${soldDate}', '${brand}');" class="link-block-4-copy w-inline-block">
                                        <img src="https://global-uploads.webflow.com/6055e6b453114a22c1c345f0/608db91c363e28ae251e0998_delivery-truck%204.svg" loading="lazy" width="34" alt="" class="image-4">
                                        <div class="text-block-17-copy">Boka hämtning</div>
                                    </a>`;
    return div;
  }

  function closePickupToast() {
    bookPickupToast.style.display = 'none';
  }

  function closeFeedbackForm() {
    feedbackForm.style.display = 'none';
  }

  function emptyListsInnerHTML() {
    itemListSelling.innerHTML = "";
    itemListSoldNotSent.innerHTML = "";
    itemListSold.innerHTML = "";
    itemListSoldByOthers.innerHTML = "";
  }

  // PICKUP RELATED FUNCTIONS
  var currentItem = "";
  var currentBrand = "";

  function openPickupToast(itemId, soldDate, brand) {
    setDatesOfPickupToast(soldDate);
    currentItem = itemId;
    currentBrand = brand;
    document.getElementById('triggerPickupAnimation').click();
  }

  function setDatesOfPickupToast(soldDate) {

    // Get the 2 first business days, 3 days after soldDate
    var firstDate = new Date(soldDate);
    var secondDate = new Date(soldDate);
    var soldDate = new Date(soldDate);

    firstDate.setDate(soldDate.getDate() + 4); // 4
    secondDate.setDate(soldDate.getDate() + 5); // 5

    // Om helgdag, skjut på det så att man bara kan välja veckodagar
    if (firstDate.getDay() == 0) {
      firstDate.setDate(firstDate.getDate() + 1);
      secondDate.setDate(firstDate.getDate() + 1);
    } else if (firstDate.getDay() == 6) {
      firstDate.setDate(firstDate.getDate() + 2);
      secondDate.setDate(firstDate.getDate() + 1);
    }

    var days = ['Söndag', 'Måndag', 'Tisdag', 'Onsdag', 'Torsdag', 'Fredag', 'Lördag'];
    var months = ['jan', 'feb', 'mar', 'apr', 'maj', 'jun', 'jul', 'aug', 'sep', 'okt', 'nov', 'dec'];
    var dateNumber1 = firstDate.getDate();
    var dateNumber2 = secondDate.getDate();
    var monthName1 = months[firstDate.getMonth()];
    var monthName2 = months[secondDate.getMonth()];
    var dayName1 = days[firstDate.getDay()];
    var dayName2 = days[secondDate.getDay()];

    // Change value of radio buttons
    $('#radioButtonOne').val(firstDate.toISOString().split('T')[0]); //yyyy-mm-dd
    $('#radioButtonTwo').val(secondDate.toISOString().split('T')[0]); //yyyy-mm-dd

    // Show dates
    pickupDateOne.innerHTML = dayName1 + ", " + dateNumber1 + " " + monthName1 + ", kl 9-16";
    pickupDateTwo.innerHTML = dayName2 + ", " + dateNumber2 + " " + monthName2 + ", kl 9-16";
  }

  async function bookPickup() {
    let pickupDate = "";
    var pickupRadioButtons = document.getElementsByName("Pickup");
    for (var x = 0; x < pickupRadioButtons.length; x++) {
      if (pickupRadioButtons[x].checked) {
        pickupDate = pickupRadioButtons[x].value; // yyyy--mm-dd
      }
    }

    const itemRef = db.collection('items').doc(currentItem);
    const res = await itemRef.update({
      pickupDate: pickupDate
    }).then(function () {
      console.log(`pickupDate is now set on Firestore item`);
      bookPickupToast.style.display = 'none';
      feedbackForm.style.display = 'block';
      happinessQuestionText.innerText = `Hur nöjd är du med försäljningen 
    av ditt ${currentBrand}-plagg?`;
    });

  }

  async function setHappinessRate(value) {
    const itemRef = db.collection('items').doc(currentItem);
    const res = await itemRef.update({
      happinessRate: value
    }).then(function () {
      console.log(`happinessRate is now set on Firestore item`);
      happinessQuestionDiv.style.display = 'none';
      openQuestionDiv.style.display = 'block';
      feedbackSubmitButton.style.display = 'block';
    });
  }

  async function storeFeedback() {
    const value = feedbackTextField.value;
    const itemRef = db.collection('items').doc(currentItem);
    const res = await itemRef.update({
      feedbackText: value
    }).then(function () {
      console.log(`feedbackText is now set on Firestore item`);
      feedbackForm.style.display = 'none';
      location.reload();
    });
  }

  function signOut() {
    firebase.auth().signOut().then(() => {
      console.log('User signed out');
    }).catch((error) => {

    });
  }

</script>

<script>
  // FUNCTIONS - SELL ITEM
  function writePhoneNumberToFirestore(userID, phoneNumber) {
    var docRef = db.collection("users").doc(userID);
    console.log("writePhoneNumberToFirestore function is running!");

    docRef.get().then((doc) => {
      if (doc.exists) {
        console.log("Document data:", doc.data());
      } else {
        // doc.data() will be undefined in this case
        console.log("No such document! Creating it now and adds phone number!");
        // Add a new document in collection "users"
        db.collection("users").doc(userID).set({
          phoneNumber: phoneNumber
        })
          .then(() => {
            console.log("User document successfully written!");
          })
          .catch((error) => {
            console.error("Error writing document: ", error);
          });
      }
    }).catch((error) => {
      console.log("Error getting document:", error);
    });
  }

  async function addItem() {

    console.log("addItem function is running!");
    let sex = "";
    let pricing = "";
    const now = new Date();
    let status = "New";
    let shippingStatus = "Not sent";
    const size = itemSize.value;
    const material = itemMaterial.value;
    const brand = itemBrand.value;
    const model = itemModel.value;
    const originalPrice = Number(itemOriginalPrice.value);
    const age = itemAge.value;

    const condition = itemCondition.value;
    const defectDescription = itemDefectDescription.value;
    const noAnimals = itemNoAnimals.checked;
    const noSmoke = itemNoSmoke.checked;
    const happyPrice = Number(itemHappyPrice.value);
    const acceptPrice = Number(itemAcceptPrice.value);
    const phoneNumber = itemPhoneNumber.value;

    let defectElements = new Map()
      .set("hole", hole.checked)
      .set("stain", stain.checked)
      .set("lostFit", lostFit.checked)
      .set("nopprig", nopprig.checked)
      .set("threadUp", threadUp.checked)
      .set("colorChange", colorChange.checked)
      .set("otherDefect", otherDefect.checked);

    let defectsChoicesInSwedish = new Map()
      .set("hole", "Hål")
      .set("stain", "Fläck")
      .set("lostFit", "Tappad passform")
      .set("nopprig", "Nopprig")
      .set("threadUp", "Trådsläpp")
      .set("colorChange", "Färgändring")
      .set("otherDefect", "Annat");

    let defects = [];

    defectElements.forEach(async (value, key) => {
      if (value == true) {
        let string = defectsChoicesInSwedish.get(key);
        defects.push(string);
      }
    });

    // Get radio buttons
    var sexRadioButtons = document.getElementsByName("Sex");
    for (var x = 0; x < sexRadioButtons.length; x++) {
      if (sexRadioButtons[x].checked) {
        sex = sexRadioButtons[x].id;
      }
    }

    // Get who sets price
    var pricingRadioButtons = document.getElementsByName("Pricing");
    for (var x = 0; x < pricingRadioButtons.length; x++) {
      if (pricingRadioButtons[x].checked) {
        pricing = pricingRadioButtons[x].id;
      }
    }

    // Add phone number to document
    writePhoneNumberToFirestore(window.uid, phoneNumber);

    // Create item in FS without the images first, to get the ItemID
    var itemId = "";
    var imagePaths = {};
    var imageUrls = {};
    imageUrls['frontImage'] = ""; // Part of the ugly hack
    createItemInFirestore();

    async function createItemInFirestore() {

      const collectionRef = db.collection('items');

      // Writes to FS
      const res = await collectionRef.add({
        user: window.uid,
        createdAt: now,
        status: status,
        shippingStatus: shippingStatus,
        sex: sex,
        size: size,
        material: material,
        brand: brand,
        model: model,
        originalPrice: originalPrice,
        age: age,
        condition: condition,
        defects: defects,
        defectDescription: defectDescription,
        noAnimals: noAnimals,
        noSmoke: noSmoke,
        pricing: pricing,
        happyPrice: happyPrice,
        acceptPrice: acceptPrice,
        images: imageUrls // To compare the change after the images have been uploaded

      })
        .then((docRef) => {
          //window.itemId = docRef.id;
          itemId = docRef.id;
          console.log("Document written with ID: ", itemId);
          uploadImages();
        })
        .catch((error) => {
          console.error("Error adding document: ", error);
        });
    }

    async function uploadImages() {
      //Gather files from the form in a map "Images"
      let elements = ["frontImage", "brandTagImage", "productImage", "defectImage", "materialTagImage", "extraImage"];
      let images = new Map();

      elements.forEach(element => {
        if (document.getElementById(element).files[0]) {
          let file = document.getElementById(element).files[0];
          images.set(element, file);
        }
      });

      // Uploads files and gather URLs in an object "imagePaths"
      const storageRef = storage.ref();

      images.forEach(async (value, key) => {

        let imagePathReference = `images/${itemId}/${key}`;
        console.log(imagePathReference);

        let fileRef = storageRef.child(imagePathReference);
        await fileRef.put(value);

        const imageDownloadUrl = await fileRef.getDownloadURL();
        imageUrls[key] = imageDownloadUrl;
        imagePaths[key] = imagePathReference;

        if (Object.keys(imagePaths).length == images.size) {
          writeImagePathToFirestore();
        }
      })
    }

    async function writeImagePathToFirestore() {

      // Check if seller has added address first
      var addressFirstName = "";
      var docRef = db.collection("users").doc(window.uid);
      await docRef.get().then((doc) => {
        if (doc.data().addressFirstName) {
          addressFirstName = doc.data().addressFirstName;
        }
      }).catch((error) => {
        console.log("Error getting document:", error);
      });

      // Set the imagePaths of the item
      const itemRef = db.collection('items').doc(itemId);
      const res = await itemRef.update({
        images: imageUrls,
        imageStoragePaths: imagePaths
      }).then(function () {
        console.log(`imagePaths of ${itemId} is now updated`);

        if (addressFirstName == "") {
          addressFormDiv.style.display = 'block';
          addItemFormDiv.style.display = 'none';
        } else {
          window.location.href = window.location.origin + "/private";
        }
      });
    }
  }


  async function addUserAddress() {
    // Grab values from form 
    const addressFirstName = document.getElementById("addressFirstName").value;
    const addressLastName = document.getElementById("addressLastName").value;
    const addressStreetAddress = document.getElementById("addressStreetAddress").value;
    const addressPostalCode = document.getElementById("addressPostalCode").value;
    const addressCity = document.getElementById("addressCity").value;
    const addressDoorCode = document.getElementById("addressDoorCode").value;

    // Write to Firestore
    const itemRef = db.collection('users').doc(window.uid);
    const res = await itemRef.update({
      addressFirstName: addressFirstName,
      addressLastName: addressLastName,
      addressStreetAddress: addressStreetAddress,
      addressPostalCode: addressPostalCode,
      addressCity: addressCity,
      addressDoorCode: addressDoorCode
    }).then(function () {
      console.log(`User address of ${uid} is now updated`);
      window.location.href = window.location.origin + "/private";
    });
  }

</script>

<script>
  function calculateSellerGets(value, elementId, feeElementId) {

    let div = document.getElementById(elementId);
    let feeDiv = document.getElementById(feeElementId);
    const price = parseFloat(value);
    let sellerGets = 0;

    if (price < 250) {
      sellerGets = Math.ceil(price - 50);
      if (sellerGets < 0) {
        sellerGets = 0;
      }
      feeDiv.innerText = `Minst 50kr kommission`;
    } else {
      sellerGets = Math.ceil(price * 0.8);
      feeDiv.innerText = `20% kommission`;
    }

    if (sellerGets >= 0) {
      div.innerText = `Du får ${sellerGets} kr`;
      div.style.display = 'block';

    } else {
      div.style.display = 'none';
    }
  }
</script>
